<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Learning App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            text-align: center;
        }
        h1 {
            background-color: #2c3e50;
            color: white;
            padding: 10px 0;
        }
        .container {
            margin: 20px;
        }
        .word-list {
            list-style-type: none;
            padding: 0;
        }
        .word-item {
            padding: 10px;
            margin: 5px;
            background-color: #ecf0f1;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .word-item:hover {
            background-color: #bdc3c7;
        }
        .highlight {
            background-color: #e74c3c;
            color: white;
        }
        .correct {
            background-color: #2ecc71;
            color: white;
        }
        .incorrect {
            background-color: #e74c3c;
            color: white;
        }
        .definition {
            margin-top: 20px;
            font-size: 1.2em;
        }
        .button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 1.1em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #3498db;
            color: white;
        }
        .button:disabled {
            background-color: #bdc3c7;
        }
        select {
            padding: 10px;
            font-size: 1.1em;
            margin-top: 20px;
        }
        #definition-title {
            font-weight: bold;
            margin-top: 20px;
            text-align: left;
            padding-left: 20px;
        }
        #word-list {
            display: block;
        }
        #end-test-button {
            background-color: #e74c3c;
            color: white;
        }
        #end-reading-button {
            background-color: #e67e22;
            color: white;
        }
    </style>
</head>
<body>

    <h1>Word Learning App</h1>

    <div class="container">
        <h2>Select Week</h2>
        <select id="week-selector">
            <option value="">-- Select Week --</option>
        </select>

        <h2>Words of the Selected Week</h2>
        <ul id="word-list" class="word-list">
            <!-- Dynamic word list will be inserted here -->
        </ul>

        <div id="definition-title">Word Definition:</div>
        <div class="definition" id="word-definition"></div>

        <button id="read-all-button" class="button" disabled>Read All Words</button>
        <button id="test-order-button" class="button" disabled>Test in Order</button>
        <button id="test-random-button" class="button" disabled>Test Random</button>
        <button id="end-reading-button" class="button" style="display:none;" onclick="endReading()">End Reading</button>
        <button id="end-test-button" class="button" style="display:none;" onclick="endTest()">End Test</button>
    </div>

    <script>
        const weekSelector = document.getElementById('week-selector');
        const wordListContainer = document.getElementById('word-list');
        const wordDefinition = document.getElementById('word-definition');
        const wordDefinitionTitle = document.getElementById('definition-title');
        const readAllButton = document.getElementById('read-all-button');
        const testOrderButton = document.getElementById('test-order-button');
        const testRandomButton = document.getElementById('test-random-button');
        const endReadingButton = document.getElementById('end-reading-button');
        const endTestButton = document.getElementById('end-test-button');
        let wordListData = [];
        let isReading = false;  // Flag to track if reading/spelling is in progress
        let isReadingAllWords = false;  // Flag for "Read All Words" process
        let currentIndex = 0;

        // Fetch word data from external JSON file
        fetch('terms/terms.json')
            .then(response => response.json())
            .then(data => {
                window.allWeeksData = data;
                populateWeekSelector();
            })
            .catch(error => {
                console.error('Error loading the word list:', error);
                alert('There was an error loading the word list.');
            });

        // Function to populate the week selector dropdown dynamically
        function populateWeekSelector() {
            const weeks = Object.keys(window.allWeeksData);
            weeks.forEach(week => {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = `Week ${week.replace('week', '')}`;
                weekSelector.appendChild(option);
            });
        }

        // Function to display words based on selected week
        function displayWords(week) {
            if (!week || !window.allWeeksData[week]) return;

            wordListContainer.innerHTML = '';
            wordDefinition.innerHTML = '';
            wordDefinitionTitle.style.display = 'none';
            readAllButton.disabled = false;
            testOrderButton.disabled = false;
            testRandomButton.disabled = false;

            wordListData = window.allWeeksData[week];

            wordListData.forEach(wordData => {
                const wordElement = document.createElement('li');
                wordElement.classList.add('word-item');
                wordElement.textContent = wordData.word;
                wordElement.dataset.word = wordData.word;
                wordElement.dataset.definition = wordData.definition;
                wordListContainer.appendChild(wordElement);

                // Add click listener to each word item
                wordElement.addEventListener('click', () => {
                    if (!isReading && !isReadingAllWords) {  // Prevent clicks if reading or 'Read All' is in progress
                        isReading = true;  // Set the flag to prevent other selections
                        highlightWord(wordElement);
                        showDefinition(wordElement);
                        speakWord(wordElement.dataset.word);
                        spellWord(wordElement.dataset.word, wordElement);
                    }
                });
            });
        }

        // Event listener for week selection
        weekSelector.addEventListener('change', (event) => {
            const selectedWeek = event.target.value;
            displayWords(selectedWeek);
        });

        // Function to speak a word (Only once)
        function speakWord(word) {
            const utterance = new SpeechSynthesisUtterance(word);
            speechSynthesis.speak(utterance);
        }

        // Function to spell a word
        function spellWord(word, wordElement) {
            const letters = word.split('');
            let letterIndex = 0;

            function spellNextLetter() {
                if (letterIndex < letters.length) {
                    const utterance = new SpeechSynthesisUtterance(letters[letterIndex]);
                    speechSynthesis.speak(utterance);
                    letterIndex++;
                    setTimeout(spellNextLetter, 500);  // Delay between letters
                } else {
                    // After spelling is done, allow user to select another word
                    setTimeout(() => {
                        isReading = false;  // Reset the flag to allow the next selection
                        highlightWord(wordElement);  // Re-highlight the word if needed
                    }, 1000);
                }
            }

            spellNextLetter();
        }

        // Function to highlight the selected word
        function highlightWord(wordElement) {
            const wordItems = document.querySelectorAll('.word-item');
            wordItems.forEach(item => item.classList.remove('highlight'));
            wordElement.classList.add('highlight');
        }

        // Function to show the definition of the selected word
        function showDefinition(wordElement) {
            wordDefinitionTitle.style.display = 'block';
            wordDefinition.textContent = wordElement.dataset.definition;
        }

        // Function to read all words in the list
        function readAllWords() {
            if (isReading || isReadingAllWords) return;  // Prevent reading if already in progress

            isReadingAllWords = true;
            readAllButton.disabled = true;  // Disable the button to prevent multiple clicks
            endReadingButton.style.display = 'inline-block';  // Show the "End Reading" button

            currentIndex = 0;
            readNextWord();
        }

        // Function to read the next word in the list
        function readNextWord() {
            if (currentIndex >= wordListData.length) {
                isReadingAllWords = false;  // Reset the flag once all words have been read
                readAllButton.disabled = false;  // Re-enable the "Read All Words" button
                endReadingButton.style.display = 'none';  // Hide the "End Reading" button
                return;
            }

            const word = wordListData[currentIndex].word;
            speakWord(word);
            highlightWord(wordListContainer.children[currentIndex]);
            showDefinition(wordListContainer.children[currentIndex]);

            setTimeout(() => {
                spellWord(word, wordListContainer.children[currentIndex]);
                currentIndex++;
                setTimeout(readNextWord, 3300);  // 0.3s longer delay between words
            }, 2000); // Wait for the word to be spoken before spelling
        }

        // Function to end the reading of all words early
        function endReading() {
            isReadingAllWords = false;  // Reset flag
            readAllButton.disabled = false;  // Re-enable "Read All Words"
            endReadingButton.style.display = 'none';  // Hide the "End Reading" button
            speechSynthesis.cancel();  // Stop current speech synthesis
        }

        // Test buttons listeners
        testOrderButton.addEventListener('click', () => startTest(false));
        testRandomButton.addEventListener('click', () => startTest(true));

        // Function to end test
        function endTest() {
            // Logic to end the test (e.g., show feedback or reset)
        }

        // Initialize everything on page load
        populateWeekSelector();
    </script>

</body>
</html>

